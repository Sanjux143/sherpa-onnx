name: Android Release APK (Debug Signed)

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      ANDROID_API: 32
      ANDROID_NDK_VERSION: 25.2.9519653
      ABI: arm64-v8a

    steps:
    # ================= CHECKOUT =================
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    # ================= JAVA =================
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17

    # ================= ANDROID SDK =================
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install Android SDK & NDK
      run: |
        sdkmanager "platforms;android-${ANDROID_API}"
        sdkmanager "ndk;${ANDROID_NDK_VERSION}"

    # ================= BUILD SHERPA-ONNX =================
    - name: Build sherpa-onnx native libs (arm64-v8a)
      run: |
        chmod +x build-android-arm64-v8a.sh
        ./build-android-arm64-v8a.sh

    - name: Copy JNI libraries
      run: |
        mkdir -p android/SherpaOnnx/app/src/main/jniLibs/${ABI}
        cp build-android-arm64-v8a/lib/*.so \
           android/SherpaOnnx/app/src/main/jniLibs/${ABI}/

    # ================= BUILD RELEASE APK =================
    - name: Build Release APK (debug signed)
      run: |
        cd android/SherpaOnnx
        ./gradlew assembleRelease

    # ================= UPLOAD RELEASE APK =================
    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: release-apk
        path: android/SherpaOnnx/app/build/outputs/apk/release/*.apk
